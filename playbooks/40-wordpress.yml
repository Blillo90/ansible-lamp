- name: Paso 9 - WordPress en Kubernetes con balanceo (replicas + Ingress)
  hosts: master
  become: true

  # Cargamos variables de forma explícita para evitar problemas de carga de group_vars
  vars_files:
    - ../group_vars/all/vars.yml

  vars:
    kubeconfig_path: /home/david/.kube/config

  pre_tasks:
    - name: Validar variables obligatorias (si falta alguna, para con error claro)
      assert:
        that:
          - wp_namespace is defined
          - wp_db_name is defined
          - wp_db_user is defined
          - wp_db_pass is defined
          - wp_db_host is defined
          - wp_replicas is defined
          - wp_image is defined
          - wp_ingress_name is defined
          - wp_host is defined
        fail_msg: >
          Faltan variables de WordPress. Revisa group_vars/all/vars.yml y define:
          wp_namespace, wp_db_name, wp_db_user, wp_db_pass, wp_db_host,
          wp_replicas, wp_image, wp_ingress_name, wp_host.

    - name: Debug variables (para confirmar que se cargan)
      debug:
        msg:
          - "wp_namespace={{ wp_namespace }}"
          - "wp_db_name={{ wp_db_name }}"
          - "wp_db_user={{ wp_db_user }}"
          - "wp_db_host={{ wp_db_host }}"
          - "wp_replicas={{ wp_replicas }}"
          - "wp_image={{ wp_image }}"
          - "wp_ingress_name={{ wp_ingress_name }}"
          - "wp_host={{ wp_host }}"

  tasks:
    # 9.1 Namespace
    - name: 9.1 Crear namespace {{ wp_namespace }}
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        wait: true
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ wp_namespace }}"

    # 9.2 Secret DB
    - name: 9.2 Crear/actualizar Secret con credenciales DB
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: wp-db-secret
            namespace: "{{ wp_namespace }}"
          type: Opaque
          stringData:
            WORDPRESS_DB_NAME: "{{ wp_db_name }}"
            WORDPRESS_DB_USER: "{{ wp_db_user }}"
            WORDPRESS_DB_PASSWORD: "{{ wp_db_pass }}"
            WORDPRESS_DB_HOST: "{{ wp_db_host }}"

    # 9.3 Deployment con replicas
    - name: 9.3 Crear/actualizar Deployment WordPress ({{ wp_replicas }} replicas)
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        wait: true
        wait_timeout: 300
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: wordpress
            namespace: "{{ wp_namespace }}"
          spec:
            replicas: {{ wp_replicas | int }}
            selector:
              matchLabels:
                app: wordpress
            template:
              metadata:
                labels:
                  app: wordpress
              spec:
                containers:
                  - name: wordpress
                    image: "{{ wp_image }}"
                    ports:
                      - containerPort: 80
                    envFrom:
                      - secretRef:
                          name: wp-db-secret

    # Service
    - name: Crear/actualizar Service wordpress-svc
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: wordpress-svc
            namespace: "{{ wp_namespace }}"
          spec:
            selector:
              app: wordpress
            ports:
              - port: 80
                targetPort: 80

    # Ingress (Traefik en k3s)
    - name: Crear/actualizar Ingress (punto de entrada unico)
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: "{{ wp_ingress_name }}"
            namespace: "{{ wp_namespace }}"
          spec:
            rules:
              - host: "{{ wp_host }}"
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: wordpress-svc
                          port:
                            number: 80

    # Esperar a que el Deployment esté disponible (más fiable que fases de pods)
    - name: Esperar a que el Deployment wordpress esté Available
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig_path }}"
        api_version: apps/v1
        kind: Deployment
        name: wordpress
        namespace: "{{ wp_namespace }}"
      register: wp_deploy_info
      until: >
        (wp_deploy_info.resources | length) > 0 and
        (wp_deploy_info.resources[0].status.availableReplicas | default(0) | int) >= (wp_replicas | int)
      retries: 40
      delay: 6

    # Comprobaciones tipo "kubectl get pods -o wide"
    - name: Mostrar pods (equivalente a kubectl -n {{ wp_namespace }} get pods -o wide)
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig_path }}"
        kind: Pod
        namespace: "{{ wp_namespace }}"
        label_selectors:
          - "app=wordpress"
      register: wp_pods_wide

    - name: Pods (nombre / nodo / IP / estado)
      debug:
        msg: >-
          {{ item.metadata.name }} | node={{ item.spec.nodeName | default('') }}
          | podIP={{ item.status.podIP | default('') }} | phase={{ item.status.phase }}
      loop: "{{ wp_pods_wide.resources }}"

    # Comprobación Ingress
    - name: Mostrar Ingress (equivalente a kubectl -n {{ wp_namespace }} get ingress)
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig_path }}"
        kind: Ingress
        namespace: "{{ wp_namespace }}"
        name: "{{ wp_ingress_name }}"
      register: wp_ing

    - name: Ingress creado
      debug:
        msg: "Ingress {{ wp_ingress_name }} host={{ wp_host }} -> service wordpress-svc:80"