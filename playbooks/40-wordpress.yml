- name: Paso 9 - WordPress en Kubernetes con balanceo (replicas + Ingress)
  hosts: master
  become: true

  vars_files:
    - ../group_vars/all/vars.yml

  vars:
    kubeconfig_path: /home/david/.kube/config

  pre_tasks:
    - name: Convertir wp_replicas a int real
      set_fact:
        wp_replicas_int: "{{ wp_replicas | int }}"

    - name: Construir manifiesto Deployment WordPress
      set_fact:
        wp_deployment_manifest:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: wordpress
            namespace: "{{ wp_namespace }}"
          spec:
            replicas: "{{ wp_replicas_int }}"
            selector:
              matchLabels:
                app: wordpress
            template:
              metadata:
                labels:
                  app: wordpress
              spec:
                containers:
                  - name: wordpress
                    image: "{{ wp_image }}"
                    ports:
                      - containerPort: 80
                    envFrom:
                      - secretRef:
                          name: wp-db-secret

    # Fuerza replicas como entero (evita error Kubernetes)
    - name: Asegurar replicas como entero
      set_fact:
        wp_deployment_manifest: >-
          {{
            wp_deployment_manifest | combine(
              {'spec': (wp_deployment_manifest.spec | combine({'replicas': wp_replicas_int | int}))}
            )
          }}

  tasks:
    # 9.1 Namespace
    - name: Crear namespace WordPress
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        wait: true
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ wp_namespace }}"

    # 9.2 Secret DB
    - name: Crear/actualizar Secret con credenciales DB
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: wp-db-secret
            namespace: "{{ wp_namespace }}"
          type: Opaque
          stringData:
            WORDPRESS_DB_NAME: "{{ wp_db_name }}"
            WORDPRESS_DB_USER: "{{ wp_db_user }}"
            WORDPRESS_DB_PASSWORD: "{{ wp_db_pass }}"
            WORDPRESS_DB_HOST: "{{ wp_db_host }}"

    # 9.3 Deployment WordPress (replicas)
    - name: Crear/actualizar Deployment WordPress
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        wait: true
        wait_timeout: 300
        definition: "{{ wp_deployment_manifest }}"

    # Service
    - name: Crear/actualizar Service wordpress-svc
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: wordpress-svc
            namespace: "{{ wp_namespace }}"
          spec:
            selector:
              app: wordpress
            ports:
              - port: 80
                targetPort: 80

    # Ingress (Traefik en k3s)
    - name: Crear/actualizar Ingress WordPress
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: "{{ wp_ingress_name }}"
            namespace: "{{ wp_namespace }}"
          spec:
            rules:
              - host: "{{ wp_host }}"
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: wordpress-svc
                          port:
                            number: 80

    # Esperar a que el deployment estÃ© disponible
    - name: Esperar a que WordPress estÃ© disponible
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig_path }}"
        api_version: apps/v1
        kind: Deployment
        name: wordpress
        namespace: "{{ wp_namespace }}"
      register: wp_deploy_info
      until: >
        (wp_deploy_info.resources[0].status.availableReplicas | default(0) | int)
        >= (wp_replicas_int | int)
      retries: 40
      delay: 6