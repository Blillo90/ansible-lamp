- name: Paso 9 - WordPress en Kubernetes con balanceo (replicas + Ingress)
  hosts: master
  become: true

  vars_files:
    - ../group_vars/all/vars.yml

  vars:
    kubeconfig_path: /home/david/.kube/config

  pre_tasks:
    - name: Validar variables obligatorias
      assert:
        that:
          - wp_namespace is defined
          - wp_db_name is defined
          - wp_db_user is defined
          - wp_db_pass is defined
          - wp_db_host is defined
          - wp_replicas is defined
          - wp_image is defined
          - wp_ingress_name is defined
          - wp_host is defined

    - name: Convertir wp_replicas a int real
      set_fact:
        wp_replicas_int: "{{ wp_replicas | int }}"

    - name: Construir manifiesto Deployment como dict (replicas int real)
      set_fact:
        wp_deployment_manifest:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: wordpress
            namespace: "{{ wp_namespace }}"
          spec:
            replicas: "{{ wp_replicas_int }}"
            selector:
              matchLabels:
                app: wordpress
            template:
              metadata:
                labels:
                  app: wordpress
              spec:
                containers:
                  - name: wordpress
                    image: "{{ wp_image }}"
                    ports:
                      - containerPort: 80
                    envFrom:
                      - secretRef:
                          name: wp-db-secret

    # clave: forzamos a que replicas sea int en el dict (no string)
    - name: Asegurar que replicas es int (no string) dentro del dict
      set_fact:
        wp_deployment_manifest: >-
          {{
            wp_deployment_manifest | combine(
              {'spec': (wp_deployment_manifest.spec | combine({'replicas': (wp_replicas_int | int)}))}
            )
          }}

  tasks:
    - name: 9.1 Crear namespace
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        wait: true
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ wp_namespace }}"

    - name: 9.2 Crear/actualizar Secret con credenciales DB
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: wp-db-secret
            namespace: "{{ wp_namespace }}"
          type: Opaque
          stringData:
            WORDPRESS_DB_NAME: "{{ wp_db_name }}"
            WORDPRESS_DB_USER: "{{ wp_db_user }}"
            WORDPRESS_DB_PASSWORD: "{{ wp_db_pass }}"
            WORDPRESS_DB_HOST: "{{ wp_db_host }}"

    - name: 9.3 Crear/actualizar Deployment WordPress (replicas int real)
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        wait: true
        wait_timeout: 300
        definition: "{{ wp_deployment_manifest }}"

    - name: Service wordpress-svc
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: wordpress-svc
            namespace: "{{ wp_namespace }}"
          spec:
            selector:
              app: wordpress
            ports:
              - port: 80
                targetPort: 80

    - name: Ingress (Traefik en k3s)
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: "{{ wp_ingress_name }}"
            namespace: "{{ wp_namespace }}"
          spec:
            rules:
              - host: "{{ wp_host }}"
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: wordpress-svc
                          port:
                            number: 80

    - name: Esperar a que el Deployment estÃ© Available
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig_path }}"
        api_version: apps/v1
        kind: Deployment
        name: wordpress
        namespace: "{{ wp_namespace }}"
      register: wp_deploy_info
      until: >
        (wp_deploy_info.resources | length) > 0 and
        (wp_deploy_info.resources[0].status.availableReplicas | default(0) | int) >= (wp_replicas_int | int)
      retries: 40
      delay: 6

    - name: Mostrar pods (como kubectl get pods -o wide)
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig_path }}"
        kind: Pod
        namespace: "{{ wp_namespace }}"
        label_selectors:
          - "app=wordpress"
      register: wp_pods_wide

    - name: Pods (nombre / nodo / IP / estado)
      debug:
        msg: >-
          {{ item.metadata.name }} | node={{ item.spec.nodeName | default('') }}
          | podIP={{ item.status.podIP | default('') }} | phase={{ item.status.phase }}
      loop: "{{ wp_pods_wide.resources }}"